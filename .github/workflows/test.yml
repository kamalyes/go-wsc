on:
  push:
    branches:
      - master
    paths:
      - "**"
      - "!docs/**"
      - "!**.md"
  pull_request:
    paths:
      - "**"
      - "!docs/**"
      - "!**.md"

name: Test
jobs:
  Build:
    strategy:
      matrix:
        go-version: [1.21.x, 1.22.x, 1.23.x, 1.24.x, 1.25.x]
        platform: [ubuntu-latest, windows-latest, macos-latest, macos-14]
      fail-fast: false  # å…è®¸å…¶ä»–çŸ©é˜µä½œä¸šç»§ç»­è¿è¡Œï¼Œå³ä½¿æœ‰äº›å¤±è´¥
    runs-on: ${{ matrix.platform }}
    timeout-minutes: 30  # è®¾ç½®ä½œä¸šè¶…æ—¶

    # ğŸ”¥ å…¨å±€ç¯å¢ƒå˜é‡
    env:
      # Redis é…ç½®
      REDIS_HOST: ${{ vars.TEST_REDIS_HOST || 'localhost' }}
      REDIS_PORT: ${{ vars.TEST_REDIS_PORT || '6379' }}
      REDIS_PASSWORD: ${{ vars.TEST_REDIS_PASSWORD || '' }}
      # MySQL é…ç½®
      MYSQL_HOST: ${{ vars.TEST_MYSQL_HOST || 'localhost' }}
      MYSQL_PORT: ${{ vars.TEST_MYSQL_PORT || '3306' }}
      MYSQL_USER: ${{ vars.TEST_MYSQL_USER || 'root' }}
      MYSQL_PASSWORD: ${{ vars.MYSQL_ROOT_PASSWORD || '1235678' }}
      MYSQL_DATABASE: ${{ vars.TEST_MYSQL_DATABASE || 'go_wsc_test' }}
      # Windows è·¯å¾„
      WINDOWS_REDIS_PATH: ${{ vars.WINDOWS_REDIS_PATH || 'C:\Program Files\Redis' }}
      WINDOWS_MYSQL_PATH: ${{ vars.WINDOWS_MYSQL_PATH || 'C:\tools\mysql\current\bin' }}
      # macOS è·¯å¾„ (Intel)
      MACOS_REDIS_CONF_INTEL: ${{ vars.MACOS_REDIS_CONF_INTEL || '/usr/local/etc/redis.conf' }}
      # macOS è·¯å¾„ (Apple Silicon)
      MACOS_REDIS_CONF_ARM: ${{ vars.MACOS_REDIS_CONF_ARM || '/opt/homebrew/etc/redis.conf' }}
    steps:
      - name: Fetch Repository
        uses: actions/checkout@v5

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest
        continue-on-error: true  # å¦‚æœå®‰è£…å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ

      - name: Download dependencies
        run: go mod download
        continue-on-error: true

      - name: Test (without coverage)
        run: gotestsum -f testname -- ./... -race -count=1 -timeout=15m -shuffle=on
        timeout-minutes: 15
        continue-on-error: true  # å³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿç»§ç»­

      - name: Test (with coverage)
        run: gotestsum -f testname -- ./... -race -count=1 -timeout=15m -coverprofile=coverage.txt -covermode=atomic -shuffle=on
        timeout-minutes: 15
        continue-on-error: true  # å³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿç»§ç»­

      - name: Upload coverage reports to Codecov
        if: always() && matrix.platform == 'ubuntu-latest' && matrix.go-version == '1.22.x'
        uses: codecov/codecov-action@v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.txt
          flags: unittests
          slug: kamalyes/go-wsc
        continue-on-error: true  # ä¸Šä¼ å¤±è´¥ä¹Ÿä¸å½±å“æ•´ä¸ªæµç¨‹