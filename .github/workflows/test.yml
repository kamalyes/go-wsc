on:
  push:
    branches:
      - master
    paths:
      - "**"
      - "!docs/**"
      - "!**.md"
  pull_request:
    paths:
      - "**"
      - "!docs/**"
      - "!**.md"

name: Test
jobs:
  Build:
    strategy:
      matrix:
        go-version: [1.21.x, 1.22.x, 1.23.x, 1.24.x, 1.25.x]
        platform: [ubuntu-latest, windows-latest, macos-latest, macos-14]
      fail-fast: false # ÂÖÅËÆ∏ÂÖ∂‰ªñÁü©Èòµ‰Ωú‰∏öÁªßÁª≠ËøêË°åÔºåÂç≥‰ΩøÊúâ‰∫õÂ§±Ë¥•
    runs-on: ${{ matrix.platform }}
    timeout-minutes: 60 # ËÆæÁΩÆ‰Ωú‰∏öË∂ÖÊó∂

    # üî• ÂÖ®Â±ÄÁéØÂ¢ÉÂèòÈáè
    env:
      # Redis ÈÖçÁΩÆ
      REDIS_HOST: ${{ vars.TEST_REDIS_HOST || 'localhost' }}
      REDIS_PORT: ${{ vars.TEST_REDIS_PORT || '6379' }}
      REDIS_PASSWORD: ${{ vars.TEST_REDIS_PASSWORD || '' }}
      # MySQL ÈÖçÁΩÆ
      MYSQL_HOST: ${{ vars.TEST_MYSQL_HOST || 'localhost' }}
      MYSQL_PORT: ${{ vars.TEST_MYSQL_PORT || '3306' }}
      MYSQL_USER: ${{ vars.TEST_MYSQL_USER || 'root' }}
      MYSQL_PASSWORD: ${{ vars.MYSQL_ROOT_PASSWORD || '1235678' }}
      MYSQL_DATABASE: ${{ vars.TEST_MYSQL_DATABASE || 'go_wsc_test' }}
    steps:
      - name: Fetch Repository
        uses: actions/checkout@v5

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest
        continue-on-error: true # Â¶ÇÊûúÂÆâË£ÖÂ§±Ë¥•ÔºåÁªßÁª≠ÊâßË°å

      - name: Download dependencies
        run: go mod download
        continue-on-error: true

      - name: Test (with coverage)
        run: gotestsum -f testname -- ./... -race -count=1 -timeout=30m -coverprofile=coverage.txt -covermode=atomic -shuffle=on
        timeout-minutes: 60
        continue-on-error: true # Âç≥‰ΩøÊµãËØïÂ§±Ë¥•‰πüÁªßÁª≠

      - name: Check coverage file exists
        id: check_coverage
        if: matrix.platform == 'ubuntu-latest' && matrix.go-version == '1.22.x'
        run: |
          if [ -f coverage.txt ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Coverage file exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Coverage file not found"
          fi
        shell: bash
        continue-on-error: true

      - name: Upload coverage reports to Codecov
        if: always() && steps.check_coverage.outputs.exists == 'true'
        uses: codecov/codecov-action@v4.5.0
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.txt
          flags: unittests
          slug: kamalyes/go-wsc
          fail_ci_if_error: false # ‰∏ä‰º†Â§±Ë¥•‰∏çÂΩ±Âìç CI
        continue-on-error: true # ‰∏ä‰º†Â§±Ë¥•‰πü‰∏çÂΩ±ÂìçÊï¥‰∏™ÊµÅÁ®ã
