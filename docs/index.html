<!--
 * @Author: kamalyes 501893067@qq.com
 * @Date: 2025-11-15 10:52:32
 * @LastEditors: kamalyes 501893067@qq.com
 * @LastEditTime: 2025-11-15 10:52:38
 * @FilePath: \go-wsc\docs\index.html
 * @Description: 
 * 
 * Copyright (c) 2025 by kamalyes, All Rights Reserved. 
-->
<!DOCTYPE html>
<html lang="zh"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        width: 100%;
        text-align: center;
      }

      .header {
        margin-bottom: 30px;
      }

      .logo {
        font-size: 2.5em;
        font-weight: bold;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
      }

      .subtitle {
        color: #666;
        font-size: 1.1em;
      }

      .status-card {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        display: flex;
        justify-content: space-around;
        text-align: center;
      }

      .status-item {
        flex: 1;
      }

      .status-value {
        font-size: 2em;
        font-weight: bold;
        color: #667eea;
        display: block;
      }

      .status-label {
        color: #666;
        font-size: 0.9em;
        margin-top: 5px;
      }

      .connection-config {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        border: 2px solid #e9ecef;
      }

      .config-group {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .config-group label {
        font-weight: bold;
        color: #555;
        min-width: 120px;
      }

      .url-input {
        flex: 1;
        min-width: 300px;
        padding: 10px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        outline: none;
        transition: border-color 0.3s;
        font-family: monospace;
      }

      .url-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .connect-btn {
        padding: 10px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
        min-width: 80px;
      }

      .connect-btn:hover {
        background: #5a67d8;
      }

      .connect-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .connect-btn.disconnect {
        background: #dc3545;
      }

      .connect-btn.disconnect:hover {
        background: #c82333;
      }

      .chat-container {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        height: 400px;
        display: flex;
        flex-direction: column;
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 15px;
        background: white;
      }

      .message {
        margin: 5px 0;
        padding: 8px 12px;
        border-radius: 8px;
        word-wrap: break-word;
      }

      .message.system {
        background: #e3f2fd;
        color: #1976d2;
      }

      .message.chat {
        background: #f3e5f5;
        color: #7b1fa2;
      }

      .message.echo {
        background: #e8f5e8;
        color: #388e3c;
      }

      .message.error {
        background: #ffebee;
        color: #d32f2f;
      }

      .input-group {
        display: flex;
        gap: 10px;
      }

      .message-input {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        outline: none;
        transition: border-color 0.3s;
      }

      .message-input:focus {
        border-color: #667eea;
      }

      .send-btn {
        padding: 12px 25px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        transition: transform 0.2s;
        font-weight: bold;
      }

      .send-btn:hover {
        transform: translateY(-2px);
      }

      .send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .connection-status {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
        margin: 10px 0;
      }

      .connection-status.connected {
        background: #c8e6c9;
        color: #2e7d32;
      }

      .connection-status.disconnected {
        background: #ffcdd2;
        color: #c62828;
      }

      .connection-status.connecting {
        background: #fff3e0;
        color: #ef6c00;
      }

      .endpoints {
        text-align: left;
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
      }

      .endpoints h3 {
        color: #667eea;
        margin-bottom: 15px;
      }

      .endpoint {
        margin: 10px 0;
        font-family: monospace;
        background: white;
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .method {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
        margin-right: 10px;
      }

      .method.get {
        background: #e8f5e8;
        color: #388e3c;
      }

      .method.post {
        background: #fff3e0;
        color: #f57c00;
      }

      .method.ws {
        background: #e3f2fd;
        color: #1976d2;
      }

        @media (max-width: 768px) {
        .container {
          margin: 20px;
          padding: 20px;
        }

        .status-card {
          flex-direction: column;
          gap: 20px;
        }

        .config-group {
          flex-direction: column;
          align-items: stretch;
        }

        .config-group label {
          min-width: auto;
        }

        .url-input {
          min-width: auto;
        }

        .chat-container {
          height: 300px;
        }

        .input-group {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">go-wsc ğŸš€</div>
        <div class="subtitle">é«˜æ€§èƒ½ WebSocket æ¡†æ¶æ¼”ç¤ºæœåŠ¡å™¨</div>
      </div>

      <!-- è¿æ¥é…ç½®åŒºåŸŸ -->
      <div class="connection-config">
        <div class="config-group">
          <label for="serverUrl">ğŸŒ æœåŠ¡å™¨åœ°å€:</label>
          <input type="text" id="serverUrl" class="url-input" placeholder="ws://localhost:8080/ws" />
          <button class="connect-btn" id="connectBtn" onclick="toggleConnection()">è¿æ¥</button>
        </div>
      </div>

      <div class="connection-status disconnected" id="connectionStatus">ğŸ”´ æœªè¿æ¥</div>

      <div class="status-card">
        <div class="status-item">
          <span class="status-value" id="clientCount">0</span>
          <div class="status-label">åœ¨çº¿å®¢æˆ·ç«¯</div>
        </div>
        <div class="status-item">
          <span class="status-value" id="messageCount">0</span>
          <div class="status-label">æ¶ˆæ¯æ€»æ•°</div>
        </div>
        <div class="status-item">
          <span class="status-value" id="uptime">00:14:37</span>
          <div class="status-label">è¿è¡Œæ—¶é—´</div>
        </div>
      </div>

      <div class="chat-container">
        <div class="messages" id="messages"><div class="message error">[10:38:32] è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div></div>
        <div class="input-group">
          <input type="text" class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled="">
          <button class="send-btn" id="sendButton" disabled="" onclick="sendMessage()">
            å‘é€
          </button>
        </div>
      </div>

      <div class="endpoints">
        <h3>ğŸ“¡ API ç«¯ç‚¹</h3>
        <div class="endpoint">
          <span class="method ws">WS</span>
          <code>ws://localhost:8080/ws</code> - WebSocket è¿æ¥
        </div>
        <div class="endpoint">
          <span class="method get">GET</span>
          <code>http://localhost:8080/api/status</code> - æœåŠ¡å™¨çŠ¶æ€
        </div>
        <div class="endpoint">
          <span class="method get">GET</span>
          <code>http://localhost:8080/api/clients</code> - å®¢æˆ·ç«¯åˆ—è¡¨
        </div>
        <div class="endpoint">
          <span class="method post">POST</span>
          <code>http://localhost:8080/api/broadcast</code> - å¹¿æ’­æ¶ˆæ¯
        </div>
      </div>
    </div>

    <script>
      let ws = null;
      let messageCount = 0;
      let startTime = Date.now();
      let reconnectAttempts = 0;
      const maxReconnectAttempts = 5;

      // è¿æ¥çŠ¶æ€ç®¡ç†
      function updateConnectionStatus(status, message) {
        const statusElement = document.getElementById("connectionStatus");
        statusElement.className = `connection-status ${status}`;
        statusElement.textContent = message;
      }

      // è¿æ¥ WebSocket
      function connectWebSocket(url) {
        if (!url) {
          url = document.getElementById('serverUrl').value.trim();
          if (!url) {
            url = getDefaultWebSocketUrl();
            document.getElementById('serverUrl').value = url;
          }
        }

        try {
          updateConnectionStatus("connecting", "ğŸ”„ æ­£åœ¨è¿æ¥...");
          ws = new WebSocket(url);

          ws.onopen = function () {
            console.log("âœ… WebSocket è¿æ¥å·²å»ºç«‹");
            updateConnectionStatus("connected", "ğŸŸ¢ å·²è¿æ¥");
            isConnected = true;
            reconnectAttempts = 0;
            
            // æ¸…é™¤é‡è¿è®¡æ—¶å™¨
            if (reconnectTimer) {
              clearTimeout(reconnectTimer);
              reconnectTimer = null;
            }

            // å¯ç”¨è¾“å…¥æ§ä»¶
            document.getElementById("messageInput").disabled = false;
            document.getElementById("sendButton").disabled = false;
            document.getElementById("connectBtn").textContent = "æ–­å¼€";
            document.getElementById("connectBtn").className = "connect-btn disconnect";

            // å‘é€è¿æ¥æˆåŠŸæ¶ˆæ¯
            addMessage("system", `å·²è¿æ¥åˆ° ${url}`);

            // å‘é€åˆå§‹æ¶ˆæ¯
            sendWebSocketMessage({
              type: "chat",
              data: "ç”¨æˆ·å·²åŠ å…¥èŠå¤©å®¤",
            });
          };

          ws.onmessage = function (event) {
            try {
              const message = JSON.parse(event.data);
              handleMessage(message);
              messageCount++;
              document.getElementById("messageCount").textContent =
                messageCount;
            } catch (e) {
              console.error("è§£ææ¶ˆæ¯å¤±è´¥:", e);
              addMessage("error", "æ”¶åˆ°æ— æ•ˆæ¶ˆæ¯: " + event.data);
            }
          };

          ws.onclose = function (event) {
            console.log("ğŸ”’ WebSocket è¿æ¥å…³é—­:", event.code, event.reason);
            
            if (!isConnected) {
              // ç”¨æˆ·ä¸»åŠ¨æ–­å¼€ï¼Œä¸é‡è¿
              return;
            }
            
            updateConnectionStatus("disconnected", "ğŸ”´ è¿æ¥å·²æ–­å¼€");
            isConnected = false;

            document.getElementById("messageInput").disabled = true;
            document.getElementById("sendButton").disabled = true;
            document.getElementById("connectBtn").textContent = "è¿æ¥";
            document.getElementById("connectBtn").className = "connect-btn";

            // è‡ªåŠ¨é‡è¿é€»è¾‘
            if (event.code !== 1000 && event.code !== 1001) {
              // 1000/1001 è¡¨ç¤ºæ­£å¸¸å…³é—­
              reconnectAttempts++;
              const delay = Math.min(reconnectDelay * reconnectAttempts, 30000); // æœ€å¤§ 30 ç§’
              updateConnectionStatus(
                "reconnecting",
                `â±ï¸ ${Math.ceil(delay / 1000)}ç§’åé‡è¿ (${reconnectAttempts}/5)`
              );

              reconnectTimer = setTimeout(() => {
                if (reconnectAttempts <= 5) {
                  connectWebSocket(url);
                } else {
                  updateConnectionStatus("error", "ğŸ”´ é‡è¿å¤±è´¥");
                  addMessage("error", "é‡è¿æ¬¡æ•°è¶…é™ï¼Œè¯·æ‰‹åŠ¨è¿æ¥");
                }
              }, delay);
            }
          };

          ws.onerror = function (error) {
            console.error("âŒ WebSocket é”™è¯¯:", error);
            updateConnectionStatus("disconnected", "ğŸ”´ è¿æ¥é”™è¯¯");
          };
        } catch (error) {
          console.error("åˆ›å»º WebSocket è¿æ¥å¤±è´¥:", error);
          updateConnectionStatus("disconnected", "ğŸ”´ è¿æ¥å¤±è´¥");
        }
      }

      // å‘é€ WebSocket æ¶ˆæ¯
      function sendWebSocketMessage(message) {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              ...message,
              timestamp: Date.now(),
            })
          );
          return true;
        }
        return false;
      }

      // å‘é€èŠå¤©æ¶ˆæ¯
      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (message && ws && ws.readyState === WebSocket.OPEN) {
          sendWebSocketMessage({
            type: "chat",
            data: message,
          });
          input.value = "";
        }
      }

      // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
      function handleMessage(message) {
        console.log("ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:", message);

        switch (message.type) {
          case "system":
            addMessage("system", `âš™ï¸ ${message.data}`);
            break;
          case "chat":
            addMessage("chat", `ğŸ’¬ ${message.data}`);
            break;
          case "echo":
            addMessage("echo", `ğŸ”„ ${message.data}`);
            break;
          case "file_received":
            addMessage("system", `ğŸ“ ${message.data}`);
            break;
          case "pong":
            console.log("ğŸ’“ æ”¶åˆ°å¿ƒè·³å“åº”");
            break;
          default:
            addMessage(
              "system",
              `ğŸ“¦ ${message.type}: ${JSON.stringify(message.data)}`
            );
        }
      }

      // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
      function addMessage(type, text) {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // æ›´æ–°è¿è¡Œæ—¶é—´
      function updateUptime() {
        const elapsed = Date.now() - startTime;
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);

        document.getElementById("uptime").textContent = `${hours
          .toString()
          .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
          .toString()
          .padStart(2, "0")}`;
      }

      // è·å–æœåŠ¡å™¨çŠ¶æ€
      function fetchServerStatus() {
        fetch("/api/status")
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("clientCount").textContent =
              data.connected_clients;
          })
          .catch((error) => {
            console.error("è·å–æœåŠ¡å™¨çŠ¶æ€å¤±è´¥:", error);
          });
      }

      // é”®ç›˜äº‹ä»¶å¤„ç†
      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });
        
      // URLè¾“å…¥æ¡†æ”¯æŒEnteré”®è¿æ¥
      document
        .getElementById("serverUrl")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !isConnected) {
            toggleConnection();
          }
        });

      // åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function() {
        // è®¾ç½®é»˜è®¤URL
        const defaultUrl = getDefaultWebSocketUrl();
        document.getElementById('serverUrl').value = defaultUrl;
        updateConnectionStatus("disconnected", "ğŸ”´ æœªè¿æ¥");
      });

      // å®šæ—¶æ›´æ–°
      setInterval(updateUptime, 1000);
      setInterval(fetchServerStatus, 5000);

      // é¡µé¢å…³é—­æ—¶æ¸…ç†
      window.addEventListener("beforeunload", function () {
        if (ws) {
          ws.close();
        }
      });
    </script>
  

</body></html>